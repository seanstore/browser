# 브라우저 런타임 환경

자바스크립트는 기본적으로는 싱글 스레딩만 지원하는 언어다.
하지만 브라우저라는 프로그램 안에는 여러 가지 쓰레드들이 들어있고, Web APIs를 이용하면 멀티 쓰레딩이 가능하다.
대표적으로 fetch API를 이용해서 백엔드로부터 데이터를 받아 오거나 setTimeout을 이용해서 일정 기간이 지난 다음 우리가 등록한 콜백 함수를 실행할 수 있다.

자바스크립트 엔진은 메모리 힙과 콜 스택을 가지고 있다.
만약 콜 스택에서 setTimeout을 호출한다고 하면 setTimeout은 콜 스택에서 사라지고, 타이머가 시작되며 타이머와 자바스크립트 엔진이 병렬적으로 실행되고 있다가 지정된 시간이 끝나면 Web APIs가 콜백을 태스크 큐 안에 집어넣는다.

이벤트 루프는 루프를 돌면서 태스크 큐와 콜 스택을 지속적으로 관찰하는 아이이며 콜 스택이 비워져서 자바스크립트 엔진이 일을 하고 있지 않을 때 태스크 큐에 있는 콜백을 콜 스택으로 한 번에 하나씩 가져다 놓는다.

프로미스에 등록된 콜백과 mutation observer의 콜백은 마이크로 태스크 큐에 들어온다.

렌더 시퀀스는 브라우저에서 변경사항을 업데이트하기 위해서 주기적으로 호출되는 순서로, requestAnimationFrame이라는 Web API를 통해 콜백을 등록해놓으면 큐에 차곡차곡 쌓아놨다가 다음에 브라우저가 업데이트될 때 실행되며, 그 다음 렌더 트리 생성, 레이아웃, 페인트, 컴포지트 순서로 실행된다.

이벤트 루프는 평소에는 루프를 돌다가 콜 스택에서 수행 중인 함수가 있다면 끝날 때까지 콜 스택에서 머무른다.
콜 스택에서 수행 중인 함수가 종료되면 다시 루프를 돌기 시작한다.
먼저 렌더 시퀀스 쪽으로는 60fps(16.7ms) 범위 내에만 브라우저를 업데이트하면 되기 때문에 갈수도 가지 않을 수도 있다.

그 다음으로는 마이크로 태스크 큐로 넘어가서 수행해야 할 콜백이 있는지 확인하고, 큐 안에 들어있는 콜백이 없어질 때까지 계속 콜 스택으로 가지고 가서 수행한다.

마이크로 태스크 큐가 텅텅 비면 이벤트 루프는 다시 순회를 재개하며 태스크 큐로 넘어간다.
태스크 큐에서는 콜백 하나만 콜 스택으로 데려와 콜백이 끝날 때까지 콜 스택에서 기다린 뒤 끝나면 다시 동그라미 순회를 재개한다.
